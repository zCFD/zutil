name: Create zUtil Release

on:
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v2024.12.1)'
        required: true
        type: string

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true && 
       startsWith(github.head_ref, 'release/v')) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            # Extract tag from PR branch name (e.g., release/v2024.12.1 -> v2024.12.1)
            TAG="${{ github.head_ref }}"
            TAG="${TAG#release/}"
          fi
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "Processing release: $TAG"

      - name: Verify version consistency
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          echo "Expected version: $VERSION"
          
          # The setup.py uses RELEASE_VERSION environment variable, so we just need to verify
          # that the code was properly synced. We can check for any version files if they exist.
          echo "âœ… Version will be set via RELEASE_VERSION environment variable during build"

      - name: Create and push Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Check if tag already exists
          if git rev-parse "${{ steps.get_tag.outputs.tag_name }}" >/dev/null 2>&1; then
            echo "Tag ${{ steps.get_tag.outputs.tag_name }} already exists, skipping tag creation"
          else
            git tag ${{ steps.get_tag.outputs.tag_name }}
            git push origin ${{ steps.get_tag.outputs.tag_name }}
            echo "Created and pushed tag: ${{ steps.get_tag.outputs.tag_name }}"
          fi

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.ZUTIL_REPO_TOKEN }}
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          release_name: zUtil ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## zUtil Release ${{ steps.get_tag.outputs.tag_name }}
            
            ðŸŽ‰ This release will be automatically published to PyPI!
            
            ### Install this version:
            ```bash
            pip install zutil==${{ steps.get_tag.outputs.version }}
            ```
            
            ### Changes:
            This release was automatically synced from the zCFD repository.
            
            The PyPI package will be built and published automatically by the existing python-publish.yml workflow.
          draft: false
          prerelease: false



      - name: Cleanup release branch
        if: github.event.pull_request.merged == true
        run: |
          # Delete the release branch after successful merge and release creation
          BRANCH_NAME="${{ github.head_ref }}"
          git push origin --delete "$BRANCH_NAME" || echo "Branch already deleted"
          echo "ðŸ§¹ Cleaned up release branch: $BRANCH_NAME"